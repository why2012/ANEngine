<!DOCTYPE html>
<head>
	<title>中500万对你有多难(测试类)</title>
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0"/>
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<script type="text/javascript" src="../ANEngine/jquery-2.0.2.min.js"></script>
	<script type="text/javascript" src="../ANEngine/hammer.min.js"></script>
	<script type="text/javascript" src="../ANEngine/Box2dWeb-2.1.a.3.js"></script>
	<script type="text/javascript" src="../ANEngine/ANEngine.js"></script>
	<script type="text/javascript" src="../ANEngine/ANEngine.Util.js"></script>
</head>
<body>
	<script>
		var Ernie = function()
			{
				this.anim = new ANEngine.MovieClip(2,3,8,8);
				var _default = 1;
				var start = 2;
				var end = 16;
				var success = 17,success_end = 20;
				var fail = 21,fail_end = 24;
				this.cur_status = 0;//fail:0,success:1
				this.anim.gotoAndStop(_default);
				var _this = this;
				this.callback = null;
				this.busy = false;
				this.result_callback = null;
				this.playSuccess_callback = null;
				this.anim.monitor = function(f,m)
				{
					if(_this.callback)
						_this.callback(f,m);
					if(!_this.busy)
					{
						if(f==end)
						{
							if(_this.cur_status==0)
								m.gotoAndPlay(fail);
							else
								m.gotoAndPlay(success);
						}
						if(f==success_end||f==fail_end)
						{							
							m.stop();
							if(_this.result_callback)
								_this.result_callback(_this.cur_status);
							if(_this.playSuccess_callback)
								_this.playSuccess_callback(_this.cur_status);
						}
					}
					else
					{
						if(f==end)
							m.gotoAndPlay(start);
					}
				}

				this.setSrc = function(img,json)
				{
					this.anim.setSpriteSheet(img,json,24);
				}

				this.start = function(rc)
				{
					this.result_callback = rc;
					this.anim.gotoAndPlay(start);
				}

				this.stop = function()
				{
					this.anim.gotoAndStop(_default);
				}

				this.playSuccess = function(c)
				{
					this.playSuccess_callback = c;
					this.anim.gotoAndPlay(success);
				}

				this.get = function(name)
				{

					switch(name)
					{
						case "success_end":return success_end;break;
						case "success":return success;break;
						case "fail_end":return fail_end;break;
						case "fail":return fail;break;
						case "end":return end;break;
						case "start":return start;break;
					}
				}
			}

		//
			var start = 0;
			var started = 0;
			var zhushu = 0;
			var max_time = 5;//出现自动帮投的次数限制
			var help_once = 0;
			var auto = false;//自动帮投
			var ernie = null;
			var rate = 5000000;
			var right_number = Math.floor(Math.random()*rate);
			var auto_max_time = Math.ceil(rate/100);//根据此设置弹出框
		//

		var again_btn = new ANEngine.Sprite(.5,8.6,5.5,1.13);//again_btn.drawBorder = true;
		var proud_btn = new ANEngine.Sprite(6.1,8.6,5.5,1.16);//proud_btn.drawBorder = true;
		var close_popup_btn = new ANEngine.Sprite(10.3,2,1.3,1.2);//close_popup_btn.drawBorder = true;
		var popup_box = new ANEngine.Sprite(.5,2,11.14,7.8);
		var zhushu_result_text = new ANEngine.Widget.Text(0,4.8,2.7,0,.5);
		var price_text = new ANEngine.Widget.Text(0,5.7,4.13,0,.5);
		var result_text_style = new ANEngine.Widget.TextStyle();
		result_text_style.fillStyle = "black";
		result_text_style.textBaseline = "hanging";
		result_text_style.font = "17px 微软雅黑";
		zhushu_result_text.textStyle = result_text_style;
		price_text.textStyle = result_text_style;
		var cover = new ANEngine.Sprite(0,0,100,100);//cover.drawBorder = true;

		var start_game = new ANEngine.Sprite(3.7,12,4,1.5);//开始游戏
		var conti_game = new ANEngine.Sprite(3.7,12,4,1.5);//继续投注
		var conti_btn = new ANEngine.Sprite(3.7,12,4,1.5);//继续自己投
		var help_btn = new ANEngine.Sprite(3.7,14,4,1.5);//中彩帮投
		var zhushu_text= new ANEngine.Widget.Text("已投注：0",3.7,1,0,1.1);
		start_game.name = "start_game";
		conti_game.name = "conti_game";
		conti_btn.name = "conti_btn";
		help_btn.name = "help_btn";
		var layer = new ANEngine.Layer();

		function getResult()
		{
			var result = Math.floor(Math.random()*rate);
			if(result == right_number)//中奖
			{
				return 1;
			}
			return 0;
		}

		function resetGame()
		{
			auto=0;
			ernie.busy=0;
			help_once=0;
			started = 0;
			start = 0;
			layer.removeAnimItem(conti_game);
			layer.removeAnimItem(conti_btn);
			layer.removeAnimItem(help_btn);
		}

		function popup(img)
		{
			popup_box.setChartlet(img);
			price_text.text = "";
			zhushu_result_text.text = zhushu;
			price_text.text = zhushu*2;
			layer.addAnimItem(start_game);
			layer.addAnimItem(cover);
			layer.addAnimItem(popup_box);
			layer.addAnimItem(zhushu_result_text);
			layer.addAnimItem(price_text);
			layer.addAnimItem(again_btn);
			layer.addAnimItem(proud_btn);
			layer.addAnimItem(close_popup_btn);
		}

		function popup_hide()
		{
			zhushu = 0;
			zhushu_text.text = "已投注：0";
			layer.removeAnimItem(zhushu_result_text);
			layer.removeAnimItem(price_text);
			layer.removeAnimItem(popup_box);
			layer.removeAnimItem(again_btn);
			layer.removeAnimItem(proud_btn);
			layer.removeAnimItem(cover);	
			layer.removeAnimItem(close_popup_btn);
		}

		//关闭弹出框
		again_btn.addEvent("mouseup",popup_hide);
		proud_btn.addEvent("mouseup",popup_hide);
		close_popup_btn.addEvent("mouseup",popup_hide);
	</script>
	<script>
		window.onload = function()
		{
			ANEngine.Platform = "desktop";//"desktop" "mobile"
			ANEngine.Scene.ShowFPS = false;
			var scene = new ANEngine.Scene(document.getElementById("canvas"));
			ANEngine.Util.Window.FullScreen(scene);
			scene.addLayer(layer);
			ernie = new Ernie();
			//Text
			layer.addAnimItem(start_game);
			layer.addAnimItem(zhushu_text);
			var notice =  new ANEngine.Widget.Text("别灰心，几率你懂得",3.7,2,0,1.1);
			notice.alpha = 0;
			layer.addAnimItem(notice);

			var textStyle = new ANEngine.Widget.TextStyle();
			textStyle.strokeStyle = "green";
			textStyle.fillStyle = "blue";
			textStyle.font = "20px 微软雅黑";
			textStyle.textBaseline = "hanging";
			zhushu_text.textStyle = textStyle;
			var notice_style = textStyle.Clone();
			notice.textStyle = notice_style;

			ernie.callback  =function(f,m)
			{
				if(auto)
				{
					//自动投注
					/*if(f==ernie.get("end"))
					{
						
					}*/
					return;
				}
				if(f==ernie.get("success_end")||f==ernie.get("fail_end"))
					start = 0;
				if(f==ernie.get("fail_end"))
					notice.animation.animate({alpha:1},300,ANEngine.Animation.TweenMode.Quart,ANEngine.Animation.EasingMode.EaseIn).delay(100).animate({alpha:0},300,ANEngine.Animation.TweenMode.Quart,ANEngine.Animation.EasingMode.EaseIn);
			}

			var loadMonitor = new ANEngine.Util.LoadMonitor();
			loadMonitor.addImgSource("assets/ernie.png");
			loadMonitor.addJsonSource("assets/ernie.json");
			loadMonitor.addImgSource("assets/start_game_down.png");
			loadMonitor.addImgSource("assets/start_game_up.png");
			loadMonitor.addImgSource("assets/conti_game_up.png");
			loadMonitor.addImgSource("assets/conti_game_down.png");
			loadMonitor.addImgSource("assets/conti_btn_up.png");
			loadMonitor.addImgSource("assets/conti_btn_down.png");
			loadMonitor.addImgSource("assets/help_up.png");
			loadMonitor.addImgSource("assets/help_down.png");
			loadMonitor.addImgSource("assets/popup_high_250.png");
			loadMonitor.addImgSource("assets/popup_low_250.png");
			loadMonitor.addImgSource("assets/bg.png",function(img){
				scene.setBG(img);
			});

			loadMonitor.onload = function(len,sources)
			{
				//ernie.anim.drawBorder = true;
				ernie.setSrc(sources["assets/ernie.png"].item,sources["assets/ernie.json"].item);
				layer.addAnimItem(ernie.anim);
				//start_game
				start_game.setChartlet(sources["assets/start_game_up.png"].item);
				conti_game.setChartlet(sources["assets/conti_game_up.png"].item);
				conti_btn.setChartlet(sources["assets/conti_btn_up.png"].item);
				help_btn.setChartlet(sources["assets/help_up.png"].item);
				var game_btn_down = sources["assets/start_game_down.png"].item;
				var game_btn_up = sources["assets/start_game_up.png"].item;
				var game_down_func = function(e){e.target.setChartlet(game_btn_down);};
				var game_up_func = function(e)
				{
					e.target.setChartlet(game_btn_up);
					if(auto)return;
					//每轮结果
					if(start==0)
					{
						//如果中奖弹出提示框，恢复游戏开始状态
						var result = getResult();
						ernie.cur_status = result;
						zhushu++;
						ernie.start(function(r){
							if(result==1)
							{
								if(zhushu<=auto_max_time)
									popup(sources["assets/popup_low_250.png"].item);
								else
									popup(sources["assets/popup_high_250.png"].item);
								if(ernie.cur_status==1)
								{
									game_btn_down = sources["assets/start_game_down.png"].item;
									game_btn_up = sources["assets/start_game_up.png"].item;
									resetGame();
									return;
								}
							}
						});
						zhushu_text.text = "已投注："+zhushu;
						start = 1;
						if(ernie.cur_status==1)
						{
							return;
						}
					}
					//开始按钮切换
					if(started==0)
					{
						started = 1;
						game_btn_down = sources["assets/conti_game_down.png"].item;
						game_btn_up = sources["assets/conti_game_up.png"].item;
						layer.removeAnimItem(start_game);
						layer.addAnimItem(conti_game);
					}
					//大于5注，显示自动投注按钮
					if(zhushu>=max_time)
					{
						game_btn_down = sources["assets/conti_btn_down.png"].item;
						game_btn_up = sources["assets/conti_btn_up.png"].item;
						layer.removeAnimItem(conti_game);
						layer.addAnimItem(conti_btn);
						layer.addAnimItem(help_btn);		
					}
				}

				var help_up_func = function(e){e.target.setChartlet(sources["assets/help_up.png"].item);};
				var help_down_func = function(e)
				{
					e.target.setChartlet(sources["assets/help_down.png"].item);
					if(help_once==0)
					{
						auto = true;
						ernie.busy = true;
						ernie.start();
						help_once = 1;
						var auto_func = function()
						{
							var num = Math.floor(Math.random()*1000)+2000;
							var help_result = 0;
							for(var i=0;i<num;i++)
							{
								/*
									如果中奖，弹出提示框，置auto=0，busy=0，help_once=0.每秒模拟250000次
									，恢复游戏开始状态
								*/
								if((help_result=getResult())==1)
								{
									//ernie.cur_status = 1;
									zhushu += i+1;
									zhushu_text.text = "已投注："+zhushu;
									ernie.busy = 0;
									ernie.playSuccess(function(){
										if(zhushu<=auto_max_time)
											popup(sources["assets/popup_low_250.png"].item);
										else
											popup(sources["assets/popup_high_250.png"].item);
										game_btn_down = sources["assets/start_game_down.png"].item;
										game_btn_up = sources["assets/start_game_up.png"].item;
										ernie.playSuccess_callback = null;
										resetGame();
									});
									break;
								}
							}

							if(help_result==0)
							{
								zhushu += num;
								zhushu_text.text = "已投注："+zhushu;
								setTimeout(auto_func,1)
							}
						};
						auto_func();
					}
				};
				start_game.addEvent("mousedown",game_down_func);
				start_game.addEvent("mouseup",game_up_func);
				conti_game.addEvent("mousedown",game_down_func);
				conti_game.addEvent("mouseup",game_up_func);
				conti_btn.addEvent("mousedown",game_down_func);
				conti_btn.addEvent("mouseup",game_up_func);
				help_btn.addEvent("mousedown",help_down_func);
				help_btn.addEvent("mouseup",help_up_func);
			}

			setInterval(function(){
				ANEngine.render(scene);
			},1000/ANEngine.fps);
		}
	</script>
	<canvas id="canvas" style="position:absolute;left:0;top:0;">Your browser does not support the HTML5 canvas tag.</canvas>
</body>