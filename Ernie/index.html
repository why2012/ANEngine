<!DOCTYPE html>
<head>
	<title>Ernie</title>
	<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0"/>
	<meta name="apple-mobile-web-app-capable" content="yes" />
	<meta name="apple-mobile-web-app-status-bar-style" content="black" />
	<meta name="format-detection" content="telephone=no" />
	<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
	<script type="text/javascript" src="../ANEngine/jquery-2.0.2.min.js"></script>
	<script type="text/javascript" src="../ANEngine/hammer.min.js"></script>
	<script type="text/javascript" src="../ANEngine/Box2dWeb-2.1.a.3.js"></script>
	<script type="text/javascript" src="../ANEngine/ANEngine.js"></script>
	<script type="text/javascript" src="../ANEngine/ANEngine.Util.js"></script>
</head>
<body>
	<script>
		var Ernie = function()
			{
				this.anim = new ANEngine.MovieClip(2,3,8,8);
				var _default = 1;
				var start = 2;
				var end = 16;
				var success = 17,success_end = 20;
				var fail = 21,fail_end = 24;
				this.cur_status = 0;//fail:0,success:1
				this.anim.gotoAndStop(_default);
				var _this = this;
				this.callback = null;
				this.busy = false;
				this.anim.monitor = function(f,m)
				{
					if(_this.callback)
						_this.callback(f,m);
					if(!_this.busy)
					{
						if(f==end)
						{
							if(_this.cur_status==0)
								m.gotoAndPlay(fail);
							else
								m.gotoAndPlay(success);
						}
						if(f==success_end||f==fail_end)
							m.stop();
					}
					else
					{
						if(f==end)
							m.gotoAndPlay(start);
					}
				}

				this.setSrc = function(img,json)
				{
					this.anim.setSpriteSheet(img,json,24);
				}

				this.start = function()
				{
					this.anim.gotoAndPlay(start);
				}

				this.stop = function()
				{
					this.anim.gotoAndStop(_default);
				}

				this.get = function(name)
				{

					switch(name)
					{
						case "success_end":return success_end;break;
						case "fail_end":return fail_end;break;
						case "end":return end;break;
						case "start":return start;break;
					}
				}
			}

		function getResult()
		{
			return	Math.floor(Math.random()*2);
		}
	</script>
	<script>
		window.onload = function()
		{
			//
				var start = 0;
				var zhushu = 0;
				var max_time = 5;
				var auto = false;//自动帮投
			//
			ANEngine.Platform = "mobile";//"desktop" "mobile"
			var scene = new ANEngine.Scene(document.getElementById("canvas"));
			ANEngine.Util.Window.FullScreen(scene);
			var layer = new ANEngine.Layer();
			scene.addLayer(layer);
			var ernie = new Ernie();
			//Text
			var start_game = new ANEngine.Sprite(3.7,12,4,1.5);
			var conti_game = new ANEngine.Sprite(3.7,12,4,1.5);
			var conti_btn = new ANEngine.Sprite(3.7,12,4,1.5);
			var help_btn = new ANEngine.Sprite(3.7,14,4,1.5);
			layer.addAnimItem(start_game);
			var zhushu_text= new ANEngine.Widget.Text("已投注：0",3.7,1,0,1.1);
			layer.addAnimItem(zhushu_text);
			var notice =  new ANEngine.Widget.Text("别灰心，几率你懂得",3.7,2,0,1.1);
			notice.alpha = 0;
			layer.addAnimItem(notice);

			var textStyle = new ANEngine.Widget.TextStyle();
			textStyle.strokeStyle = "green";
			textStyle.fillStyle = "blue";
			textStyle.font = "20px Verdana";
			textStyle.textBaseline = "hanging";
			zhushu_text.textStyle = textStyle;
			var notice_style = textStyle.Clone();
			notice.textStyle = notice_style;

			ernie.callback  =function(f,m)
			{
				if(auto)
				{
					//自动投注
					/*if(f==ernie.get("end"))
					{
						
					}*/
					return;
				}
				if(f==ernie.get("success_end")||f==ernie.get("fail_end"))
					start = 0;
				if(f==ernie.get("fail_end"))
					notice.animation.animate({alpha:1},300,ANEngine.Animation.TweenMode.Quart,ANEngine.Animation.EasingMode.EaseIn).delay(1000).animate({alpha:0},300,ANEngine.Animation.TweenMode.Quart,ANEngine.Animation.EasingMode.EaseIn);
			}

			var loadMonitor = new ANEngine.Util.LoadMonitor();
			loadMonitor.addImgSource("assets/ernie.png");
			loadMonitor.addJsonSource("assets/ernie.json");
			loadMonitor.addImgSource("assets/start_game_down.png");
			loadMonitor.addImgSource("assets/start_game_up.png");
			loadMonitor.addImgSource("assets/conti_game_up.png");
			loadMonitor.addImgSource("assets/conti_game_down.png");
			loadMonitor.addImgSource("assets/conti_btn_up.png");
			loadMonitor.addImgSource("assets/conti_btn_down.png");
			loadMonitor.addImgSource("assets/help_up.png");
			loadMonitor.addImgSource("assets/help_down.png");
			loadMonitor.addImgSource("assets/bg.png",function(img){
				scene.setBG(img);
			});

			loadMonitor.onload = function(len,sources)
			{
				ernie.anim.drawBorder = true;
				ernie.setSrc(sources["assets/ernie.png"].item,sources["assets/ernie.json"].item);
				layer.addAnimItem(ernie.anim);
				//start_game
				start_game.setChartlet(sources["assets/start_game_up.png"].item);
				conti_game.setChartlet(sources["assets/conti_game_up.png"].item);
				conti_btn.setChartlet(sources["assets/conti_btn_up.png"].item);
				help_btn.setChartlet(sources["assets/help_up.png"].item);
				var game_btn_down = sources["assets/start_game_down.png"].item;
				var game_btn_up = sources["assets/start_game_up.png"].item;
				var game_down_func = function(e){e.target.setChartlet(game_btn_down);};
				var started = 0;
				var game_up_func = function(e)
				{
					e.target.setChartlet(game_btn_up);
					if(auto)return;
					if(start==0)
					{
						//如果中奖弹出提示框，恢复游戏开始状态
						ernie.cur_status = getResult();
						zhushu++;
						ernie.start();
						zhushu_text.text = "已投注："+zhushu;
						start = 1;
					}
					if(started==0)
					{
						started = 1;
						game_btn_down = sources["assets/conti_game_down.png"].item;
						game_btn_up = sources["assets/conti_game_up.png"].item;
						layer.removeAnimItem(start_game);
						layer.addAnimItem(conti_game);
					}
					if(zhushu>=max_time)
					{
						game_btn_down = sources["assets/conti_btn_down.png"].item;
						game_btn_up = sources["assets/conti_btn_up.png"].item;
						layer.removeAnimItem(conti_game);
						layer.addAnimItem(conti_btn);	
						layer.addAnimItem(help_btn);	
					}
				}

				var help_once = 0;//中奖后置0
				var help_up_func = function(e){e.target.setChartlet(sources["assets/help_up.png"].item);};
				var help_down_func = function(e)
				{
					e.target.setChartlet(sources["assets/help_down.png"].item);
					if(help_once==0)
					{
						auto = true;
						ernie.busy = true;
						ernie.start();
						help_once = 1;
						var interval = setInterval(function(){
							zhushu++;
							zhushu_text.text = "已投注："+zhushu;
							/*
								如果中奖，弹出提示框，置auto=0，busy=0，help_once=0.每秒模拟250000次
								，恢复游戏开始状态
							*/
						},1)
					}
				};
				start_game.addEvent("mousedown",game_down_func);
				start_game.addEvent("mouseup",game_up_func);
				conti_game.addEvent("mousedown",game_down_func);
				conti_game.addEvent("mouseup",game_up_func);
				conti_btn.addEvent("mousedown",game_down_func);
				conti_btn.addEvent("mouseup",game_up_func);
				help_btn.addEvent("mousedown",help_down_func);
				help_btn.addEvent("mouseup",help_up_func);
			}

			setInterval(function(){
				ANEngine.render(scene);
			},1000/ANEngine.fps);
		}
	</script>
	<canvas id="canvas" style="position:absolute;left:0;top:0;">Your browser does not support the HTML5 canvas tag.</canvas>
</body>